# Тестовое задание "Сервис уведомлений"

## В данном задании было реализовано:

- Добавление нового клиента в справочник со всеми атрибутами
- обновления данных атрибутов клиента
- удаления клиента из справочника 
- добавления новой рассылки со всеми её атрибутами 
- получения общей статистики по созданным рассылкам и количеству отправленных сообщений по ним с группировкой по статусам 
- получения детальной статистики отправленных сообщений по конкретной рассылке 
- обновления атрибутов рассылки 
- удаления рассылки 
- обработки активных рассылок и отправки сообщений клиентам

## А также по дополнительным заданииям:
- Сборка всего проекта с помощью docker-compose
- Swagger UI по эндпоинту /api/docs
- Обработка ошибок по внешнему сервису рассылки сообщений(при неуспешной отправке, по умолчанию каждый час производится попытка повторной отправки сообщения, если данная рассылка еще активна )
- Логирование событий

## Сборка и запуск проекта:
Перед сборкой и запуском проекта необходимо переименовать файл **.env.example** в **.env**.
В данном файле описаны все переменные, которые используются в сервисе, а именно:
- DJANGO_SETTINGS_MODULE - Отвечает за нахождение модуля настроек Django
- TOKEN_MESSAGE_SERVICE - JWT-token внешнего сервиса рассылки
- URL_MESSAGE_SERVICE -URL сервиса рассылки 
- POSTGRES_USER - Имя пользователя БД
- POSTGRES_PASSWORD - Пароль пользователя БД
- POSTGRES_DB - Имя базы данных
- POSTGRES_HOST - Хост, на котором располагается БД
- POSTGRES_PORT - Порт БД
- RABBITMQ_DEFAULT_USER - Имя пользователя RabbitMQ
- RABBITMQ_DEFAULT_PASS - Пароль пользователя RabbitMQ
- CELERY_BROKER_URL - Строка подключения к RabbitMQ 
- TIME_FOR_CHECKING_NEWSLETTERS - Время проверки на наличие неотправленных рассылок в формате CRON
- TIME_FOR_CHECKING_MESSAGES - Время проверки наличия неотправленных сообщений в формате CRON

Пример значений переменных находится в файле **.env.example**

Сборка и запуск проекта осуществляется с помощью docker-compose:
~~~
docker-compose up --build -d
~~~

После запуска контейнеров, на локальной машине по адресу `http://localhost:8000/api/docs` будет доступен SwaggerUI

Возможные штатные варианты ответов представлены по каждому эндпоинту.

## Логика работы сервиса:
После запуска контейнеров, необходимо добавить клиентов по методу `/api/clients/create`.
При небходимости изменить данные клиента, необходимо по методу `/api/clients/update` передать номер телефона, который является идентификатором клиента, и остальные поля, которые необходимо изменить.
Для удаления клиента из базы необходимо по методу `/api/clients/delete` передать номер телефона и он будет удален из базы.

Для создания рассылки необходимо по методу `/api/newletter/create` передать все данные рассылки. В случае, если время ее начала меньше текущего времени, то рассылка начнет выполняться, в противном случае начнется выполнение позже.
Для изменения данных рассылки, необходимо по методу `/api/newsletter/update` передать новые данные рассылки. По методу `/api/newsletter/delete` рассылка удаляется из базы.

Для получения статистики по всем рассылкам, необходимо сделать запрос по методу `/api/newsletter/statistic_all`. В ответе будут содержаться все рассылки и количество отправленных/неотправленных сообщений, а также общее количество клиентов по тегу, который был указан в рассылке.

Для получения статистики по конкретной рассылке, необходимо сделать запрос по методу `/api/newsletter/statistic_by_id/id=<id>`.

При активации рассылки, создаются сообщений, которые будут отправлены пользователяи и их выполнение передается в очередь. В очереди функция меняет статус сообщения в зависимости от результата выполнения. В случае, если сообщение не было отправлено, оно будет повторно направлено в очередь.

## Используемые технологии:

- Django, Django ORM
- NinjaAPI
- Celery
- RabbitMQ
- PostgreSQL